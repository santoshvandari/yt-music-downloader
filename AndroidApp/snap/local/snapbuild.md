# Flutter to Snap Development Guide

## Quick Reference Commands

### Initial Setup (One-time)
```bash
# Install required tools
sudo snap install flutter --classic
sudo snap install snapcraft --classic

# Enable Linux desktop support
flutter config --enable-linux-desktop
```

### Standard Build Process
```bash
# 1. Navigate to your Flutter project root (where pubspec.yaml is)
cd ~/Desktop/yt-music-downloader/AndroidApp

# 2. Clean and build Flutter bundle
flutter clean
flutter pub get
flutter build linux --release

# 3. Clean previous snap builds
snapcraft clean

# 4. Build snap package
snapcraft pack

# 5. Install and test locally
sudo snap install --dangerous --devmode *.snap
```

## Project Structure

Your Flutter project should have this structure:
```
AndroidApp/ (your Flutter root)
├── pubspec.yaml
├── snapcraft.yaml                      ← Create this
├── lib/
├── build/linux/x64/release/bundle/
│   └── yt_music_flutter               ← Generated by flutter build
├── snap/
│   ├── gui/
│   │   ├── yt_music_downloader.desktop ← Create this
│   │   └── icon.png                    ← Add your icon
│   └── local/                          ← Put non-snap files here
│       └── any-other-files.md
└── other Flutter files...
```

## Configuration Files

### snapcraft.yaml
```yaml
name: yt-music-downloader
base: core22
version: '1.0.0'
summary: YouTube Music Downloader
description: A simple Flutter-based app for downloading YouTube Music tracks.
grade: stable
confinement: strict

apps:
  yt-music-downloader:
    command: bin/yt_music_flutter
    plugs:
      - desktop
      - desktop-legacy
      - x11
      - wayland
      - network
      - network-bind
      - home
      - removable-media
      - gsettings
      - audio-playback
      - pulseaudio
    extensions:
      - gnome

parts:
  yt-music-downloader:
    plugin: dump
    source: build/linux/x64/release/bundle
    source-type: local
    stage-packages:
      - libgtk-3-0
      - libglib2.0-0
      - libgobject-2.0-0
      - libwayland-egl1
      - libxcb-render0
      - libxcb-shm0
      - libxcb1
      - libxkbcommon0
      - libegl1-mesa
      - libgl1-mesa-glx
      - libglu1-mesa
    organize:
      '*': bin/
    override-build: |
      craftctl default
      chmod +x $CRAFTCTL_PART_INSTALL/bin/yt_music_flutter

slots:
  yt-music-downloader:
    interface: dbus
    bus: session
    name: com.example.ytmusicdownloader
```

### snap/gui/yt_music_downloader.desktop
```ini
[Desktop Entry]
Name=YouTube Music Downloader
Comment=Download YouTube Music tracks easily
Exec=yt-music-downloader
Icon=${SNAP}/meta/gui/icon.png
Terminal=false
Type=Application
Categories=AudioVideo;Audio;Utility;
StartupNotify=true
MimeType=text/uri-list;
```

## Development Workflow

### Making Changes
```bash
# After modifying your Flutter code
flutter build linux --release
snapcraft clean
snapcraft pack

# Remove old version and install new one
sudo snap remove yt-music-downloader
sudo snap install --dangerous --devmode *.snap
```

### Version Updates
```bash
# 1. Update version in snapcraft.yaml
# 2. Update version in pubspec.yaml (recommended)
# 3. Rebuild
flutter build linux --release
snapcraft pack
```

### Testing Different Confinement Modes
```bash
# Test in devmode (less restrictive, for development)
sudo snap install --dangerous --devmode yt-music-downloader_*.snap

# Test in strict mode (for production/store)
sudo snap remove yt-music-downloader
sudo snap install --dangerous yt-music-downloader_*.snap
```

## Troubleshooting

### Common Issues & Solutions

#### "snap directory contains non-snapcraft files"
```bash
# Move files to snap/local/
mkdir -p snap/local
mv snap/unwanted-file.md snap/local/
```

#### "Flutter bundle not found"
```bash
# Ensure Flutter bundle exists
ls -la build/linux/x64/release/bundle/yt_music_flutter

# If missing, rebuild Flutter
flutter build linux --release
```

#### "App won't start after installation"
```bash
# Check snap logs
snap logs yt-music-downloader

# Test in devmode first
sudo snap install --dangerous --devmode *.snap

# Check permissions
snap connections yt-music-downloader
```

#### "Missing libraries"
```bash
# Check what libraries your app needs
ldd build/linux/x64/release/bundle/yt_music_flutter

# Add missing libraries to stage-packages in snapcraft.yaml
```

#### "Network access denied"
```bash
# Ensure network plug is connected
snap connections yt-music-downloader
sudo snap connect yt-music-downloader:network
```

### Debugging Commands
```bash
# Check snap info
snap info yt-music-downloader

# View logs
snap logs yt-music-downloader
journalctl -f | grep yt-music-downloader

# Check AppArmor denials
sudo dmesg | grep DENIED

# List snap files
unsquashfs -l yt-music-downloader_*.snap

# Test Flutter app directly
./build/linux/x64/release/bundle/yt_music_flutter
```

## Store Publication

### Prepare for Store
```bash
# Test in strict confinement
sudo snap install --dangerous yt-music-downloader_*.snap

# Ensure app works without devmode
```

### Upload to Store
```bash
# Login to snapcraft
snapcraft login

# Register snap name (one-time)
snapcraft register yt-music-downloader

# Upload to edge channel
snapcraft upload yt-music-downloader_*.snap --release=edge

# After testing, promote to stable
snapcraft release yt-music-downloader 1 stable
```

## File Checklist

Before building, ensure you have:

- [ ] `snapcraft.yaml` in project root
- [ ] `snap/gui/yt_music_downloader.desktop`
- [ ] `snap/gui/icon.png` (256x256 or larger)
- [ ] Flutter bundle: `build/linux/x64/release/bundle/yt_music_flutter`
- [ ] No non-snapcraft files in `snap/` (move to `snap/local/`)

## Quick Commands Reference

```bash
# Full build cycle
flutter build linux --release && snapcraft clean && snapcraft pack

# Install and run
sudo snap install --dangerous --devmode *.snap && yt-music-downloader

# Update workflow
flutter build linux --release && snapcraft pack && sudo snap remove yt-music-downloader && sudo snap install --dangerous --devmode *.snap

# Debug
snap logs yt-music-downloader

# Clean everything
flutter clean && snapcraft clean && rm -f *.snap
```